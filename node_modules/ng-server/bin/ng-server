#!/usr/bin/env node

var configManager = require('../lib/config-manager');
var Context = require('../lib/context');

var argv = require('optimist')
                  .boolean('cors')
                  .argv;

if (argv.h || argv.help) {

    console.log([
        'usage: ng-server'
    ].join('\n'));

    process.exit();
}

var GLOBAL_CONTEXT = {};

configManager.loadConfig(argv, function (config) {
    loadContexts (config);    
});

function loadContexts (config) {
    
    var portTest = /[0-9]{4}/;
    for (var port in config) {
        if (portTest.test(port)) {
            GLOBAL_CONTEXT[port] = new Context(port, config[port]);
            GLOBAL_CONTEXT[port].init();
            GLOBAL_CONTEXT[port].startServer();
        }
    }
};
